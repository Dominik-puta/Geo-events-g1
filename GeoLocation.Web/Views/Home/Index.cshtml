@using GeoLocation.Model
@model List<Event>

@{var counter = 0;}

<div class="index-container">

    <form>
        <div style="width: 100%; margin-bottom: 30px">
            <input type="text" class="searchbox" name="searchString" id="searchString" placeholder="Pretražite po naslovu" />
        </div>
    </form>
    <div class="map-search-container">
        <form novalidate>
            <input type="number" name="lat" id="lat" hidden />
            <input type="number" name="lng" id="lng" hidden />
            <div class="map-search-text">Pretražite događaje u krugu</div>
            <input class="map-search-input" type="number" name="radius" id="radius" />
            <div class="map-search-text">km</div>
            <div id="map"></div>
            <input type="submit" value="submit" hidden />
        </form>
    </div>
    <button class="btn btn-primary clear-searches-btn" onclick="location.href = '@(Url.Action("Index", "Home"))'">Očisti pretraživanja</button>
    <div class="row">
        @foreach (var item in Model)
    {
        if (counter != 0 && counter % 2 == 0)
        {
                @:</div>
                @:<div class="row">
            }

            var base64 = Convert.ToBase64String(item.Image.ImageFile);
            var imgSrc = String.Format("data:image/gif;base64,{0}", base64);
            <div class="col-md-6">
                <div class="thumbnail">
                    <img src='@imgSrc' class="thumbnail-img" />
                    <div class="caption">
                        <h3>@item.Name</h3>
                        <p>@item.Description</p>
                        <p><strong>@item.StartDate.ToString("dd/MM/yyyy HH:mm") - @item.EndDate.ToString("dd/MM/yyyy HH:mm")</strong></p>
                        <div class="btn-container">
                            <a class="btn btn-primary" onclick="location.href = '@(Url.Action("EventDetails", "Home", new EventDetailsViewModel{ EventId = item.Id }))'">Detalji</a>
                            <a class="btn btn-danger" asp-controller="Home" asp-action="DeleteEvent" asp-route-id='@item.Id'>Obriši</a>
                        </div>
                    </div>
                </div>
            </div>

            counter++;
        }
    </div>
</div>

<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-core.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-service.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
<script>
    var platform = new H.service.Platform({
        app_id: 'djjwJitUsSXrdRYlUse2',
        app_code: '00VX2XyikFomgHBCZwDrRw',
        useHTTPS: true
    });
    var pixelRatio = window.devicePixelRatio || 1;
    var defaultLayers = platform.createDefaultLayers({
        tileSize: pixelRatio === 1 ? 256 : 512,
        ppi: pixelRatio === 1 ? undefined : 320
    });
    var map = new H.Map(document.getElementById('map'),
        defaultLayers.normal.map, {
            center: { lat: 45, lng: 18 },
            zoom: 7,
            pixelRatio: pixelRatio
        });
    var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
    var ui = H.ui.UI.createDefault(map, defaultLayers);

    var marker = new H.map.Marker({ lat: 45, lng: 18 });
    // Ensure that the marker can receive drag events
    marker.draggable = true;
    map.addObject(marker);
    var position = marker.getPosition();
    document.getElementById("lat").value = position.lat;
    document.getElementById("lng").value = position.lng;

    // disable the default draggability of the underlying map
    // when starting to drag a marker object:
    map.addEventListener('dragstart', function (ev) {
        var target = ev.target;
        if (target instanceof H.map.Marker) {
            behavior.disable();
        }
    }, false);


    // re-enable the default draggability of the underlying map
    // when dragging has completed
    map.addEventListener('dragend', function (ev) {
        var target = ev.target;
        if (target instanceof mapsjs.map.Marker) {
            behavior.enable();
        }
        position = target.getPosition();
        document.getElementById("lat").value = position.lat;
        document.getElementById("lng").value = position.lng;
    }, false);

    // Listen to the drag event and move the position of the marker
    // as necessary
    map.addEventListener('drag', function (ev) {
        var target = ev.target,
            pointer = ev.currentPointer;
        if (target instanceof mapsjs.map.Marker) {
            target.setPosition(map.screenToGeo(pointer.viewportX, pointer.viewportY));
        }
    }, false);
</script>
@*@{
        ViewData["Title"] = "Geo Events";
    }
    <div class="container body-content">
        <div class="panel panel-default">
            <div class="panel-heading">
                @ViewData["Title"]
            </div>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <td>Event</td>
                        <td>Description</td>
                        <td>Entry Fee</td>
                        <td>Limited Space</td>
                        <td>Organizer</td>
                        <td>Location</td>
                        <td>Start</td>
                        <td>End</td>
                        <td>Category</td>
                        <td>Subcategory</td>
                        <td>Venue</td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr onclick="location.href = '@(Url.Action("EventDetails", "Home", new EventDetailsViewModel{ EventId = item.Id }))'"
                            style="cursor: pointer">
                            <td>@item.Name</td>
                            <td>@item.Description</td>
                            <td>@item.EntryFee kn</td>
                            <td>@item.LimitedSpace</td>
                            <td>@item.Organizer</td>
                            <td>
                                <a href='@string.Format("https://www.google.com/maps/search/?api=1&query={0},{1}", item.Lat, item.Long)'>
                                    @item.Lat,
                                    @item.Long
                                </a>
                            </td>
                            <td>@item.StartDate</td>
                            <td>@item.EndDate</td>
                            <td>@item.CategoryName</td>
                            <td>@item.SubCategoryName</td>
                            <td>@item.VenueName</td>
                            <td style="vertical-align: middle">
                                <a asp-controller="Home" asp-action="DeleteEvent" asp-route-id='@item.Id'>
                                    &#x2716
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>*@
